<script type="text/javascript"
    src="https://cdn.jsdelivr.net/gh/mistiansen/HVR-Scripts@master/cities.js"
    async="" defer="">
</script>

<script>
    function initAutocomplete() {
        // initCityAutocomplete();      
        initAddressAutocomplete();
    }    

    // function initCityAutocomplete() {
    //     // var input = document.getElementById('search-buy');
    //     // var options = {
    //     //     types: ['(cities)'],
    //     //     componentRestrictions: {country: 'us'}
    //     // };
    //     // var autocomplete = new google.maps.places.Autocomplete(input, options);
    //     var inputs = document.getElementsByClassName('city-input');
    
    //     var options = {
    //         // types: ['(cities)'],
    //         componentRestrictions: {country: 'us'}
    //     };        
    
    //     var autocompletes = [];
    
    //     for (var i = 0; i < inputs.length; i++) {
    //         var autocomplete = new google.maps.places.Autocomplete(inputs[i], options);
    //         autocomplete.inputId = inputs[i].id;
    //         autocomplete.addListener('place_changed', fillInCity);
    //         autocompletes.push(autocomplete);
    //     }        
    // }

    function fillInCity() {
      // Get the place details from the autocomplete object.
      var place = this.getPlace();

      if (typeof place.formatted_address != "undefined") {
        console.log(this.inputId);
        console.log(place.formatted_address);
        document.getElementById(this.inputId).value = place.formatted_address;
      }
      for (var i = 0; i < place.address_components.length; i++) {
          let component = place.address_components[i];
          let componentType = place.address_components[i].types[0];
              if (componentType == "locality") {
                let city = component.short_name;
                console.log('LOCALITY!!');            
                console.log('Got this city: ' + city);
                $('#city-storage').attr("value", city);
              } else if (componentType == "administrative_area_level_1") {
                let state = component.short_name;
                console.log('Got this state: ' + state);
                $('#state-storage').attr("value", state);
              }
        }       
    }    

    function initAddressAutocomplete() {
        var inputs = document.getElementsByClassName('address-input');
    
        var options = {
            componentRestrictions: {country: ['us']}
        };
    
        var autocompletes = [];
    
        for (var i = 0; i < inputs.length; i++) {
            var autocomplete = new google.maps.places.Autocomplete(inputs[i], options);
            autocomplete.inputId = inputs[i].id;
            autocomplete.addListener('place_changed', fillInAddress);
            autocompletes.push(autocomplete);
        }
    }

    function fillInAddress() {
      // Get the place details from the autocomplete object.
      var place = this.getPlace();

      let lat = place.geometry.location.lat();
      let lng = place.geometry.location.lng();
      console.log(lat);
      console.log(lng);      

      if (typeof place.formatted_address != "undefined") {
        console.log(this.inputId);
        console.log(place.formatted_address);
        document.getElementById(this.inputId).value = place.formatted_address;
        $('#lat-storage').attr("value", lat);
        $('#lng-storage').attr("value", lng);        
      }
      for (var i = 0; i < place.address_components.length; i++) {
          let component = place.address_components[i];
          let componentType = place.address_components[i].types[0];
              if (componentType == "locality") {
                let city = component.short_name;
                console.log('LOCALITY!!');            
                console.log('Got this city: ' + city);
                $('#city-storage').attr("value", city);
              } else if (componentType == "administrative_area_level_1") {
                let state = component.short_name;
                console.log('Got this state: ' + state);
                $('#state-storage').attr("value", state);
              }
        }       
    }
</script>  

<script>
    async function submitAddress(submitAddressBtnSelector, addressInputId, visitorType) {
        // e.preventDefault(); // prevent webflow defaults
        let address = document.getElementById(addressInputId).value.trim();
        if (address) {
            $(submitAddressBtnSelector).val("Going...");
            console.log('Routing with address ' + address);
        } else {
            console.log('Nothing entered');
            return;
        }

        let routeToUrl = await determineDestination(address, visitorType);
        
        console.log('Routing to URL ' + routeToUrl);
        location.href = routeToUrl;        
    }

    async function determineDestination(address, visitorType) {
        const urlParams = new URLSearchParams(window.location.search);
        let dest = urlParams.get('to');
        let city = urlParams.get('city');
        let state = urlParams.get('state');
        console.log('Got dest: ' + dest);
        console.log('Got city: ' + city);

        console.log('No city or dest explicitly specified, pulling from address');
        city = $("#city-storage").val();
        state = $("#state-storage").val();
        console.log('City, state from storage ' + city + ' ' + state);
        
        let cityFmt = city.toLowerCase().split(" ").join("-");
        console.log(cityFmt);
        let stateFmt = state.toLowerCase().split(" ").join("-");
        console.log(stateFmt);
        
        let toPath;
        let cityId = cityFmt + "-" + stateFmt;                
        if (agentFixupCities.includes(cityId)) {
            toPath = "cities/" + cityId;                  
        } else {
            let lat = $("#lat-storage").val();
            let lng = $("#lng-storage").val();
            console.log('Need to find closest city to: ' + lat + ' ' + lng);
            await $.ajax({
                url: 'https://hhvjdbhqp4.execute-api.us-east-1.amazonaws.com/prod/city',
                method: 'POST',
                data: JSON.stringify({'cityId': cityId, 'stateId': stateFmt, 'lat': lat, 'lng': lng}),
            }).done(function (result) {
                let closestCityId = result.closest_city_id;
                console.log('Successfully found the closest city: ' + closestCityId);
                toPath = "cities/" + closestCityId;                  
            }).fail(function (err) {
                console.log('Unabled to find closest city');
                console.log(err);
                toPath = "general";                          
            });            
        }

        let routeToPathBase = 'https://agentfixup.com/' + toPath;
        // let queryString = '?address=' + encodeURIComponent(address) + '&visitor=' + encodeURIComponent(visitorType);
        let queryString = '?address=' + encodeURIComponent(address) + '&city=' + encodeURIComponent(city) + '&state=' + encodeURIComponent(state) + '&visitor=' + encodeURIComponent(visitorType);
        let routeToUrl = routeToPathBase + queryString;        
        return routeToUrl;
    }

    $("body").on("click", "#submit-address-btn", async function (e) {
        e.preventDefault(); // prevent webflow defaults
        submitAddress("#submit-address-btn", "address", "seller");
    });
    
    $("body").on("click", "#submit-address-buy-btn", async function (e) {
        e.preventDefault(); // prevent webflow defaults
        submitAddress("#submit-address-buy-btn", "address-buy", "buyer");
    });    

    $("body").on("click", "#submit-address-buy-sell-btn", async function (e) {
        e.preventDefault(); // prevent webflow defaults
        submitAddress("#submit-address-buy-sell-btn", "address-sell-buy", "seller-buyer");
    });  
</script>

 